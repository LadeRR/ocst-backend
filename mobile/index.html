<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>OCST Mobil</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #0f0;
      min-height: 100vh;
      padding: 0;
    }
    
    .container { 
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h2 { 
      text-align: center;
      margin: 20px 0;
      color: #0f0;
      text-shadow: 0 0 10px #0f0;
      font-size: 1.8rem;
    }
    
    .form-group {
      margin: 15px 0;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #0f0;
      font-size: 1rem;
    }
    
    input, textarea, select, button { 
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      background: #000;
      color: #0f0;
      border: 2px solid #0f0;
      border-radius: 8px;
      font-family: inherit;
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    button { 
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    button:active { 
      background: #0f0;
      color: #000;
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: #0f0;
      color: #000;
      border-color: #0f0;
      box-shadow: 0 4px 15px rgba(0, 255, 0, 0.4);
    }
    
    .btn-primary:active {
      background: #000;
      color: #0f0;
    }
    
    #chatLog { 
      height: 200px;
      overflow-y: auto;
      border: 2px solid #0f0;
      padding: 12px;
      margin: 15px 0;
      background: #000;
      font-size: 0.95rem;
      border-radius: 8px;
    }
    
    #chatLog div {
      margin: 8px 0;
      padding: 8px;
      background: rgba(0, 255, 0, 0.1);
      border-left: 3px solid #0f0;
      padding-left: 10px;
      border-radius: 4px;
    }
    
    .hidden { 
      display: none !important;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid #0f0;
      border-radius: 12px;
      font-size: 0.85rem;
      margin: 10px 0;
    }
    
    .section {
      background: rgba(0, 255, 0, 0.05);
      border: 2px solid #0f0;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    
    h3 {
      color: #0f0;
      text-shadow: 0 0 8px #0f0;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .chat-input-group {
      display: flex;
      gap: 10px;
    }
    
    .chat-input-group input {
      flex: 1;
    }
    
    .chat-input-group button {
      width: auto;
      padding: 16px 24px;
    }
  </style>
</head>
<body>
  <div id="loginContainer" class="container">
    <h2>ðŸš” OCST MOBÄ°L GÄ°RÄ°Åž</h2>
    <div class="section">
      <div class="form-group">
        <label>KullanÄ±cÄ± AdÄ±</label>
        <input id="username" placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± girin" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Åžifre</label>
        <input id="password" type="password" placeholder="Åžifrenizi girin" autocomplete="off">
      </div>
      <button class="btn-primary" onclick="login()">GÄ°RÄ°Åž YAP</button>
    </div>
  </div>

  <div id="mainContainer" class="container hidden">
    <h2>ðŸš” OCST MOBÄ°L</h2>
    <div class="status-badge">Sisteme BaÄŸlÄ± âœ“</div>
    
    <div class="section">
      <h3>Yeni Ã‡aÄŸrÄ± OluÅŸtur</h3>
      <div class="form-group">
        <label>Konum / Adres</label>
        <input id="location" placeholder="Ã–rn: Taksim MeydanÄ±">
      </div>
      <div class="form-group">
        <label>Olay AÃ§Ä±klamasÄ±</label>
        <textarea id="description" placeholder="DetaylÄ± aÃ§Ä±klama..."></textarea>
      </div>
      <div class="form-group">
        <label>Ã–ncelik Seviyesi</label>
        <select id="priority">
          <option>DÃ¼ÅŸÃ¼k</option>
          <option>Orta</option>
          <option selected>YÃ¼ksek</option>
          <option>Acil</option>
        </select>
      </div>
      <button class="btn-primary" onclick="sendCall()">Ã‡AÄžRI GÃ–NDER</button>
    </div>

    <div class="section">
      <h3>Dispatch Ä°letiÅŸim</h3>
      <div id="chatLog"></div>
      <div class="chat-input-group">
        <input id="chatInput" placeholder="Mesaj yazÄ±n...">
        <button onclick="sendChat()">â†’</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const API_URL = 'https://ocstbackend-1.onrender.com';
    const socket = io(API_URL);
    let user = null;

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      
      if (!username) return alert('KullanÄ±cÄ± adÄ± girin');
      if (!password) return alert('Åžifre girin');

      try {
        const res = await fetch(`${API_URL}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();
        if (data.user) {
          user = data.user;
          document.getElementById('loginContainer').classList.add('hidden');
          document.getElementById('mainContainer').classList.remove('hidden');
          socket.emit('join', user.id);
        } else {
          alert(data.error || 'GiriÅŸ hatasÄ±');
        }
      } catch (err) {
        alert('BaÄŸlantÄ± hatasÄ±: ' + err.message);
      }
    }

    async function sendCall() {
      const location = document.getElementById('location').value.trim();
      const description = document.getElementById('description').value.trim();
      const priority = document.getElementById('priority').value;

      if (!location || !description) {
        return alert('Konum ve aÃ§Ä±klama zorunlu!');
      }

      try {
        const res = await fetch(`${API_URL}/api/calls`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            location, 
            description, 
            priority,
            createdBy: user.username // Ã‡aÄŸrÄ±yÄ± oluÅŸturan kullanÄ±cÄ±
          })
        });

        if (res.ok) {
          alert('âœ“ Ã‡aÄŸrÄ± baÅŸarÄ±yla gÃ¶nderildi!');
          document.getElementById('location').value = '';
          document.getElementById('description').value = '';
        } else {
          alert('GÃ¶nderme hatasÄ±');
        }
      } catch (err) {
        alert('Hata: ' + err.message);
      }
    }

    function sendChat() {
      const text = document.getElementById('chatInput').value.trim();
      if (!text || !user) return;
      
      socket.emit('chat-message', { 
        userId: user.id,
        username: user.username,
        message: text
      });
      document.getElementById('chatInput').value = '';
    }

    socket.on('chat-message', (msg) => {
      const log = document.getElementById('chatLog');
      const username = msg.username || 'Bilinmeyen';
      const message = msg.message || '';
      
      if (username && message) {
        log.innerHTML += `<div><strong>${username}:</strong> ${message}</div>`;
        log.scrollTop = log.scrollHeight;
      }
    });

    socket.on('location-request', () => {
      if (confirm('Dispatch konumunuzu Ã¶ÄŸrenmek istiyor. PaylaÅŸmak ister misiniz?')) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            socket.emit('share-location', { 
              lat: pos.coords.latitude, 
              lon: pos.coords.longitude,
              userId: user.id
            });
            alert('âœ“ Konum paylaÅŸÄ±ldÄ±');
          },
          (err) => alert('Konum alÄ±namadÄ±: ' + err.message),
          { enableHighAccuracy: true }
        );
      }
    });

    socket.on('notification', (msg) => {
      alert('ðŸ“¢ Dispatch Bildirimi:\n\n' + msg);
    });

    socket.on('chat-cleared', () => {
      document.getElementById('chatLog').innerHTML = '';
      alert('Sohbet temizlendi');
    });

    // Enter ile giriÅŸ yapma
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });

    // Enter ile mesaj gÃ¶nderme
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat();
    });
  </script>
</body>
</html>
